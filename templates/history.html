<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable History - AI Timetable Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/dashboard">
                <img src="/static/assets/logo.svg" alt="Logo" width="40" height="40" class="me-2">
                AI Timetable Generator
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
                <button class="btn btn-outline-light btn-sm ms-2" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="page-header animate-fade-in">
                    <h1 class="display-6 fw-bold mb-3">
                        <i class="fas fa-history me-3"></i>Timetable History
                    </h1>
                    <p class="lead text-muted">View, edit, and manage your previously created timetables.</p>
                </div>
            </div>
        </div>

        <!-- Filter and Search -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card animate-slide-in">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchInput" placeholder="Search timetables..." onkeyup="filterHistory()">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="courseFilter" onchange="filterHistory()">
                                    <option value="">All Courses</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="dateFilter" onchange="filterHistory()">
                                    <option value="">All Dates</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-danger w-100" onclick="clearHistory()">
                                    <i class="fas fa-trash me-1"></i>Clear All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Items -->
        <div class="row" id="historyContainer">
            <!-- Dynamic content -->
        </div>

        <!-- Bulk Actions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card animate-fade-in">
                    <div class="card-header bg-warning">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-tools me-2"></i>Bulk Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <button class="btn btn-outline-success w-100" onclick="selectAll()">
                                    <i class="fas fa-check-square me-2"></i>Select All
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" onclick="clearSelection()">
                                    <i class="fas fa-square me-2"></i>Clear Selection
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-danger w-100" onclick="deleteSelected()">
                                    <i class="fas fa-trash me-2"></i>Delete Selected
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-info w-100" onclick="exportSelected('pdf')">
                                    <i class="fas fa-file-pdf me-2"></i>Export PDF
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-success w-100" onclick="exportSelected('excel')">
                                    <i class="fas fa-file-excel me-2"></i>Export Excel
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-primary w-100" onclick="duplicateSelected()">
                                    <i class="fas fa-copy me-2"></i>Duplicate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Modal -->
    <div class="modal fade" id="viewModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-eye me-2"></i>View Timetable
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="timetableView">
                        <!-- Dynamic content -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <div class="btn-group">
                        <button type="button" class="btn btn-danger" onclick="exportFromModal('pdf')">
                            <i class="fas fa-file-pdf me-1"></i>PDF
                        </button>
                        <button type="button" class="btn btn-success" onclick="exportFromModal('excel')">
                            <i class="fas fa-file-excel me-1"></i>Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>Edit Timetable
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm" class="needs-validation" novalidate>
                        <input type="hidden" id="editId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editTitle" class="form-label">Title</label>
                                    <input type="text" class="form-control" id="editTitle" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editCourse" class="form-label">Course</label>
                                    <input type="text" class="form-control" id="editCourse" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editClass" class="form-label">Class</label>
                                    <input type="text" class="form-control" id="editClass" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editWorkingDays" class="form-label">Working Days</label>
                                    <select class="form-select" id="editWorkingDays">
                                        <option value="5">5 Days</option>
                                        <option value="6">6 Days</option>
                                        <option value="7">7 Days</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editMaxHours" class="form-label">Max Hours per Day</label>
                                    <select class="form-select" id="editMaxHours">
                                        <option value="6">6 Hours</option>
                                        <option value="7">7 Hours</option>
                                        <option value="8">8 Hours</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editFreeLectures" class="form-label">Free Lectures</label>
                                    <input type="number" class="form-control" id="editFreeLectures" min="0" max="10">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateTimetable()">
                        <i class="fas fa-save me-2"></i>Update
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p>&copy; 2025 AI Timetable Generator. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/common.js"></script>
    <script>
        let currentViewData = null;
        let selectedItems = new Set();

        // Load and display history on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
            populateCourseFilter();
        });

        function loadHistory() {
            const history = getFromStorage('aitt-history') || [];
            const container = document.getElementById('historyContainer');
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-history fa-3x mb-3"></i>
                            <h5>No Timetables Found</h5>
                            <p>Create your first timetable to see it here.</p>
                            <a href="/dashboard" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Create Timetable
                            </a>
                        </div>
                    </div>
                `;
                return;
            }

            // Sort by creation date (newest first)
            history.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            let html = '';
            history.forEach((item, index) => {
                const date = new Date(item.createdAt).toLocaleDateString();
                const time = new Date(item.createdAt).toLocaleTimeString();
                
                html += `
                    <div class="col-lg-6 mb-4 history-item animate-slide-up" data-id="${item.id}">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="${item.id}" onchange="toggleSelection(this)">
                                    <label class="form-check-label fw-bold">
                                        ${item.title}
                                    </label>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="viewTimetable('${item.id}')">
                                            <i class="fas fa-eye me-2"></i>View
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="editTimetable('${item.id}')">
                                            <i class="fas fa-edit me-2"></i>Edit
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="duplicateTimetable('${item.id}')">
                                            <i class="fas fa-copy me-2"></i>Duplicate
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" href="#" onclick="exportTimetableById('${item.id}', 'pdf')">
                                            <i class="fas fa-file-pdf me-2"></i>Export PDF
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="exportTimetableById('${item.id}', 'excel')">
                                            <i class="fas fa-file-excel me-2"></i>Export Excel
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteHistoryItem('${item.id}')">
                                            <i class="fas fa-trash me-2"></i>Delete
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>${date}
                                        <i class="fas fa-clock ms-2 me-1"></i>${time}
                                    </small>
                                </div>
                                <div class="mb-2">
                                    <span class="badge bg-primary me-1">${item.data.courseName || 'N/A'}</span>
                                    <span class="badge bg-secondary">${item.data.className || 'N/A'}</span>
                                </div>
                                <div class="text-muted small">
                                    <i class="fas fa-calendar-week me-1"></i>${item.data.workingDays || 5} days/week
                                    <i class="fas fa-clock ms-2 me-1"></i>${item.data.maxHoursPerDay || 6} hrs/day
                                </div>
                            </div>
                            <div class="card-footer bg-light">
                                <div class="btn-group w-100">
                                    <button class="btn btn-outline-primary btn-sm" onclick="viewTimetable('${item.id}')">
                                        <i class="fas fa-eye me-1"></i>View
                                    </button>
                                    <button class="btn btn-outline-success btn-sm" onclick="editTimetable('${item.id}')">
                                        <i class="fas fa-edit me-1"></i>Edit
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="exportTimetableById('${item.id}', 'pdf')">
                                        <i class="fas fa-download me-1"></i>PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function populateCourseFilter() {
            const history = getFromStorage('aitt-history') || [];
            const courses = [...new Set(history.map(item => item.data.courseName).filter(Boolean))];
            const filter = document.getElementById('courseFilter');
            
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course;
                option.textContent = course;
                filter.appendChild(option);
            });
        }

        function filterHistory() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const courseFilter = document.getElementById('courseFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const items = document.querySelectorAll('.history-item');

            items.forEach(item => {
                const id = item.dataset.id;
                const history = getFromStorage('aitt-history') || [];
                const historyItem = history.find(h => h.id === id);
                
                if (!historyItem) return;

                let show = true;

                // Search filter
                if (searchTerm) {
                    const searchableText = [
                        historyItem.title,
                        historyItem.data.courseName,
                        historyItem.data.className
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchTerm)) {
                        show = false;
                    }
                }

                // Course filter
                if (courseFilter && historyItem.data.courseName !== courseFilter) {
                    show = false;
                }

                // Date filter
                if (dateFilter) {
                    const itemDate = new Date(historyItem.createdAt);
                    const now = new Date();
                    
                    switch (dateFilter) {
                        case 'today':
                            if (itemDate.toDateString() !== now.toDateString()) {
                                show = false;
                            }
                            break;
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            if (itemDate < weekAgo) {
                                show = false;
                            }
                            break;
                        case 'month':
                            const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                            if (itemDate < monthAgo) {
                                show = false;
                            }
                            break;
                    }
                }

                item.style.display = show ? 'block' : 'none';
            });
        }

        function viewTimetable(id) {
            const history = getFromStorage('aitt-history') || [];
            const item = history.find(h => h.id === id);
            
            if (!item) return;

            currentViewData = item;
            const modal = new bootstrap.Modal(document.getElementById('viewModal'));
            
            // Generate timetable HTML
            const timetableHtml = generateTimetableHTML(item.data);
            document.getElementById('timetableView').innerHTML = timetableHtml;
            
            modal.show();
        }

        function editTimetable(id) {
            const history = getFromStorage('aitt-history') || [];
            const item = history.find(h => h.id === id);
            
            if (!item) return;

            // Populate edit form
            document.getElementById('editId').value = id;
            document.getElementById('editTitle').value = item.title;
            document.getElementById('editCourse').value = item.data.courseName || '';
            document.getElementById('editClass').value = item.data.className || '';
            document.getElementById('editWorkingDays').value = item.data.workingDays || 5;
            document.getElementById('editMaxHours').value = item.data.maxHoursPerDay || 6;
            document.getElementById('editFreeLectures').value = item.data.freeLectures || 0;

            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        }

        function updateTimetable() {
            const form = document.getElementById('editForm');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            const id = document.getElementById('editId').value;
            const history = getFromStorage('aitt-history') || [];
            const itemIndex = history.findIndex(h => h.id === id);
            
            if (itemIndex === -1) return;

            // Update the item
            history[itemIndex].title = document.getElementById('editTitle').value;
            history[itemIndex].data.courseName = document.getElementById('editCourse').value;
            history[itemIndex].data.className = document.getElementById('editClass').value;
            history[itemIndex].data.workingDays = parseInt(document.getElementById('editWorkingDays').value);
            history[itemIndex].data.maxHoursPerDay = parseInt(document.getElementById('editMaxHours').value);
            history[itemIndex].data.freeLectures = parseInt(document.getElementById('editFreeLectures').value);

            // Save to storage
            saveToStorage('aitt-history', history);

            // Close modal and reload
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            loadHistory();
            
            showToast('Timetable updated successfully!', 'success');
        }

        function duplicateTimetable(id) {
            const history = getFromStorage('aitt-history') || [];
            const original = history.find(h => h.id === id);
            
            if (!original) return;

            const duplicate = {
                ...original,
                id: generateId(),
                title: `${original.title} (Copy)`,
                createdAt: new Date().toISOString()
            };

            history.push(duplicate);
            saveToStorage('aitt-history', history);
            loadHistory();
            
            showToast('Timetable duplicated successfully!', 'success');
        }

        function deleteHistoryItem(id) {
            if (!confirm('Are you sure you want to delete this timetable?')) return;

            const history = getFromStorage('aitt-history') || [];
            const updatedHistory = history.filter(h => h.id !== id);
            
            saveToStorage('aitt-history', updatedHistory);
            loadHistory();
            
            showToast('Timetable deleted successfully!', 'success');
        }

        function exportTimetableById(id, format) {
            const history = getFromStorage('aitt-history') || [];
            const item = history.find(h => h.id === id);
            
            if (!item) return;

            exportTimetableData(item.data, format);
        }

        function exportFromModal(format) {
            if (currentViewData) {
                exportTimetableData(currentViewData.data, format);
            }
        }

        function toggleSelection(checkbox) {
            if (checkbox.checked) {
                selectedItems.add(checkbox.value);
            } else {
                selectedItems.delete(checkbox.value);
            }
        }

        function selectAll() {
            const checkboxes = document.querySelectorAll('.history-item input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (!cb.checked) {
                    cb.checked = true;
                    selectedItems.add(cb.value);
                }
            });
        }

        function clearSelection() {
            const checkboxes = document.querySelectorAll('.history-item input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            selectedItems.clear();
        }

        function deleteSelected() {
            if (selectedItems.size === 0) {
                showToast('No items selected', 'warning');
                return;
            }

            if (!confirm(`Are you sure you want to delete ${selectedItems.size} selected timetable(s)?`)) return;

            const history = getFromStorage('aitt-history') || [];
            const updatedHistory = history.filter(h => !selectedItems.has(h.id));
            
            saveToStorage('aitt-history', updatedHistory);
            selectedItems.clear();
            loadHistory();
            
            showToast('Selected timetables deleted successfully!', 'success');
        }

        function exportSelected(format) {
            if (selectedItems.size === 0) {
                showToast('No items selected', 'warning');
                return;
            }

            const history = getFromStorage('aitt-history') || [];
            selectedItems.forEach(id => {
                const item = history.find(h => h.id === id);
                if (item) {
                    exportTimetableData(item.data, format);
                }
            });
        }

        function duplicateSelected() {
            if (selectedItems.size === 0) {
                showToast('No items selected', 'warning');
                return;
            }

            const history = getFromStorage('aitt-history') || [];
            const newItems = [];

            selectedItems.forEach(id => {
                const original = history.find(h => h.id === id);
                if (original) {
                    newItems.push({
                        ...original,
                        id: generateId(),
                        title: `${original.title} (Copy)`,
                        createdAt: new Date().toISOString()
                    });
                }
            });

            history.push(...newItems);
            saveToStorage('aitt-history', history);
            selectedItems.clear();
            loadHistory();
            
            showToast(`${newItems.length} timetable(s) duplicated successfully!`, 'success');
        }

        function clearHistory() {
            if (!confirm('Are you sure you want to clear all history? This action cannot be undone.')) return;

            saveToStorage('aitt-history', []);
            loadHistory();
            
            showToast('History cleared successfully!', 'success');
        }
    </script>
</body>
</html>
